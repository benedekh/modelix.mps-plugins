package org.modelix.model.mpsplugin.plugin

import com.intellij.openapi.actionSystem.AnActionEvent
import com.intellij.openapi.actionSystem.CommonDataKeys
import com.intellij.openapi.project.Project
import jetbrains.mps.ide.actions.MPSCommonDataKeys
import jetbrains.mps.workbench.action.ActionAccess
import jetbrains.mps.workbench.action.BaseAction
import org.modelix.model.mpsplugin.ModuleBinding
import org.modelix.model.mpsplugin.history.CloudBindingTreeNode
import javax.swing.Icon

/*Generated by MPS */
class Unbind_Action : BaseAction("Unbind", "", ICON) {
    init {
        setIsAlwaysVisible(false)
        this.actionAccess = ActionAccess.UNDO_PROJECT
    }

    override fun isDumbAware(): Boolean {
        return true
    }

    override fun isApplicable(event: AnActionEvent, _params: Map<String, Any>): Boolean {
        val bindingTreeNode = (event.getData(MPSCommonDataKeys.TREE_NODE) as CloudBindingTreeNode?)!!
        val binding = bindingTreeNode.binding
        // Project binding cannot currently be removed
        return binding is ModuleBinding
    }

    public override fun doUpdate(event: AnActionEvent, _params: Map<String, Any>) {
        setEnabledState(event.presentation, isApplicable(event, _params))
    }

    override fun collectActionData(event: AnActionEvent, _params: Map<String, Any>): Boolean {
        if (!super.collectActionData(event, _params)) {
            return false
        }
        run {
            val p = event.getData(CommonDataKeys.PROJECT) ?: return false
        }
        run {
            val p = event.getData(MPSCommonDataKeys.TREE_NODE) ?: return false
        }
        return true
    }

    public override fun doExecute(event: AnActionEvent, _params: Map<String, Any>) {
        val bindingTreeNode = (event.getData(MPSCommonDataKeys.TREE_NODE) as CloudBindingTreeNode?)!!
        val binding = bindingTreeNode.binding
        // Project binding cannot currently be removed
        val moduleBinding = binding as ModuleBinding
        val modelServer = bindingTreeNode.modelServer
        modelServer!!.removeBinding(moduleBinding)
        val repositoryInModelServer = bindingTreeNode.repositoryInModelServer
        PersistedBindingConfiguration.Companion.getInstance(
            event.getData<Project>(
                CommonDataKeys.PROJECT,
            ),
        )!!.removeBoundModule(repositoryInModelServer, moduleBinding)
    }

    companion object {
        private val ICON: Icon? = null
    }
}
