package org.modelix.model.mpsplugin.plugin

import com.intellij.openapi.actionSystem.AnActionEvent
import com.intellij.openapi.actionSystem.CommonDataKeys
import com.intellij.openapi.project.Project
import com.intellij.openapi.ui.Messages
import jetbrains.mps.ide.actions.MPSCommonDataKeys
import jetbrains.mps.internal.collections.runtime.ISelector
import jetbrains.mps.internal.collections.runtime.ListSequence
import jetbrains.mps.workbench.action.ActionAccess
import jetbrains.mps.workbench.action.BaseAction
import org.modelix.model.api.INode
import org.modelix.model.api.IReferenceLink
import org.modelix.model.api.PNodeAdapter
import org.modelix.model.mpsplugin.CloudRepository
import org.modelix.model.mpsplugin.history.CloudNodeTreeNode
import org.modelix.model.mpsplugin.history.CloudNodeTreeNodeBinding
import org.modelix.model.mpsplugin.history.TreeNodeClassification
import java.util.Objects
import javax.swing.Icon
import javax.swing.tree.TreeNode

/*Generated by MPS */
class ShowReferencesAction : BaseAction("Show References", "", ICON) {
    init {
        setIsAlwaysVisible(false)
        actionAccess = ActionAccess.NONE
    }

    override fun isDumbAware(): Boolean {
        return true
    }

    override fun isApplicable(event: AnActionEvent, _params: Map<String, Any>): Boolean {
        return TreeNodeClassification.isProperNode(event.getData(MPSCommonDataKeys.TREE_NODE))
    }

    public override fun doUpdate(event: AnActionEvent, _params: Map<String, Any>) {
        setEnabledState(event.presentation, isApplicable(event, _params))
    }

    override fun collectActionData(event: AnActionEvent, _params: Map<String, Any>): Boolean {
        if (!(super.collectActionData(event, _params))) {
            return false
        }
        run({
            val p: Project? = event.getData(CommonDataKeys.PROJECT)
            if (p == null) {
                return false
            }
        })
        run({
            val p: TreeNode? = event.getData(MPSCommonDataKeys.TREE_NODE)
            if (p == null) {
                return false
            }
        })
        return true
    }

    public override fun doExecute(event: AnActionEvent, _params: Map<String, Any>) {
        val nodeTreeNode: CloudNodeTreeNode = (event.getData(MPSCommonDataKeys.TREE_NODE) as CloudNodeTreeNode?)!!
        val treeInRepository: CloudRepository = CloudNodeTreeNodeBinding.getTreeInRepository(nodeTreeNode)
        // I need to know in which module to look for this node
        val sb: StringBuilder = StringBuilder()
        treeInRepository.runRead(object : Runnable {
            override fun run() {
                val node: INode = nodeTreeNode.node
                val referenceLinks: List<IReferenceLink> = node.concept!!.getAllReferenceLinks()
                for (refLink: String? in ListSequence.fromList<IReferenceLink>(referenceLinks)
                    .select<String>(object : ISelector<IReferenceLink, String>() {
                        override fun select(it: IReferenceLink): String {
                            return it.name
                        }
                    }).concat(ListSequence.fromList<String>(node.getReferenceRoles())).distinct()) {
                    sb.append(refLink)
                    sb.append(" -> ")
                    val target: INode? = node.getReferenceTarget((refLink)!!)
                    if (target is PNodeAdapter) {
                        val targetAsPNA: PNodeAdapter = target
                        if (!(Objects.equals(targetAsPNA.branch, nodeTreeNode.branch))) {
                            sb.append("[branch " + targetAsPNA.branch.getId() + "] ")
                        }
                        sb.append("#")
                        sb.append(java.lang.Long.toHexString(targetAsPNA.nodeId))
                    } else {
                        sb.append(target)
                    }
                    sb.append("\n")
                }
            }
        })
        Messages.showMessageDialog(event.getData(CommonDataKeys.PROJECT), sb.toString(), "References", null)
    }

    companion object {
        private val ICON: Icon? = null
    }
}
