package org.modelix.model.mpsplugin.projectview

import jetbrains.mps.ide.ui.tree.module.ProjectModuleTreeNode
import jetbrains.mps.ide.ui.tree.smodel.SModelTreeNode
import jetbrains.mps.internal.collections.runtime.ISelector
import jetbrains.mps.internal.collections.runtime.Sequence
import org.jetbrains.mps.openapi.model.SModel
import org.jetbrains.mps.openapi.model.SModelReference
import org.jetbrains.mps.openapi.module.SModule
import org.jetbrains.mps.openapi.module.SModuleListenerBase
import javax.swing.JTree
import javax.swing.SwingUtilities
import javax.swing.tree.DefaultTreeModel

/*Generated by MPS */
class CloudModuleTreeNode(module: SModule) : ProjectModuleTreeNode(module) {
    private var myInitialized: Boolean = false
    private val moduleListener: SModuleListenerBase = object : SModuleListenerBase() {
        override fun modelAdded(module: SModule, model: SModel) {
            update()
        }

        override fun modelRemoved(module: SModule, ref: SModelReference) {
            SwingUtilities.invokeLater(object : Runnable {
                override fun run() {
                    update()
                }
            })
        }
    }

    init {
        nodeIdentifier = module.moduleId.toString()
        icon = CloudProjectViewExtension.Companion.MODULE_ICON
        module.addModuleListener(moduleListener)
    }

    override fun getModuleText(): String {
        return (module.moduleName)!!
    }

    override fun isInitialized(): Boolean {
        return myInitialized
    }

    override fun doInit() {
        populate()
        myInitialized = true
    }

    protected fun populate() {
        val models: Iterable<SModel> = module.models
        for (model: SModel? in Sequence.fromIterable<SModel>(models).sort(
            object : ISelector<SModel, String>() {
                override fun select(it: SModel): String {
                    return it.name.longName
                }
            },
            true,
        )) {
            val tn: SModelTreeNode = SModelTreeNode((model)!!)
            tn.icon = CloudProjectViewExtension.Companion.MODEL_ICON
            tn.baseIcon = CloudProjectViewExtension.Companion.MODEL_ICON
            add(tn)
        }
        check_7wx4yo_a2a8(check_7wx4yo_a0c0i(tree, this), this)
    }

    override fun doUpdate() {
        super.doUpdate()
        myInitialized = false
        removeAllChildren()
    }

    fun dispose() {
        module.removeModuleListener(moduleListener)
    }

    companion object {
        private fun check_7wx4yo_a2a8(
            checkedDotOperand: DefaultTreeModel?,
            checkedDotThisExpression: CloudModuleTreeNode,
        ) {
            if (null != checkedDotOperand) {
                checkedDotOperand.nodeStructureChanged(checkedDotThisExpression)
            }
        }

        private fun check_7wx4yo_a0c0i(
            checkedDotOperand: JTree?,
            checkedDotThisExpression: CloudModuleTreeNode,
        ): DefaultTreeModel? {
            if (null != checkedDotOperand) {
                return checkedDotOperand.model as DefaultTreeModel?
            }
            return null
        }
    }
}
